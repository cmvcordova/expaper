#!/usr/bin/env python3
"""
Mode B: Snapshot experiment config for reproducibility.
Freezes configuration and pins tool version.

Usage:
  python scripts/snapshot_experiment geomancy integration_test --tag v1.0
  python scripts/snapshot_experiment geomancy integration_test --tag v1.0 --commit
"""

import argparse
import subprocess
import sys
from datetime import datetime
from pathlib import Path

import yaml


def load_meta() -> dict:
    """Load meta.yaml."""
    meta_path = Path("configs/meta.yaml")
    if not meta_path.exists():
        print("[ERROR] configs/meta.yaml not found")
        sys.exit(1)
    return yaml.safe_load(meta_path.read_text())


def get_tool_commit(tool_path: Path) -> str:
    """Get current commit SHA of tool submodule."""
    result = subprocess.run(
        ["git", "rev-parse", "HEAD"],
        cwd=tool_path,
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return "unknown"
    return result.stdout.strip()[:7]


def resolve_config(tool_info: dict, tool: str, experiment: str) -> str:
    """Resolve config to flat YAML using Hydra."""
    entrypoint = tool_info["entrypoint"]
    tool_dir = Path(tool_info["path"]).resolve()
    config_dir = Path(f"configs/{tool}").resolve()

    if entrypoint.startswith("-m "):
        module = entrypoint[3:]
        cmd = ["python", "-m", module]
    else:
        cmd = ["python", entrypoint]

    cmd.extend([
        f"--config-path={config_dir}",
        f"--config-name=experiment/{experiment}",
        "--cfg=job",
    ])

    # Check if in venv
    in_venv = sys.prefix != sys.base_prefix
    if not in_venv:
        cmd = ["uv", "run"] + cmd

    result = subprocess.run(cmd, cwd=tool_dir, capture_output=True, text=True)

    if result.returncode != 0:
        print(f"[ERROR] Failed to resolve config: {result.stderr}")
        sys.exit(1)

    return result.stdout


def main():
    parser = argparse.ArgumentParser(description="Snapshot an experiment config")
    parser.add_argument("tool", help="Tool name")
    parser.add_argument("experiment", help="Experiment name")
    parser.add_argument("--tag", required=True, help="Snapshot tag (e.g., v1.0, camera-ready)")
    parser.add_argument("--commit", action="store_true", help="Create git commit and tag")
    parser.add_argument("--message", help="Custom commit message")
    args = parser.parse_args()

    # Validate environment
    if not Path("configs").exists():
        print("[ERROR] configs/ directory not found. Run from project root.")
        sys.exit(1)

    # Load metadata
    meta = load_meta()
    tools = meta.get("tools", {})

    if args.tool not in tools:
        print(f"[ERROR] Tool '{args.tool}' not found in meta.yaml")
        sys.exit(1)

    tool_info = tools[args.tool]
    tool_path = Path(tool_info["path"])

    # Verify experiment exists
    experiment_file = Path(f"configs/{args.tool}/experiment/{args.experiment}.yaml")
    if not experiment_file.exists():
        print(f"[ERROR] Experiment not found: {experiment_file}")
        sys.exit(1)

    print(f"[INFO] Snapshotting: {args.tool}/{args.experiment}")
    print(f"[INFO] Tag: {args.tag}")

    # Get tool commit
    tool_commit = get_tool_commit(tool_path)
    print(f"[INFO] Tool commit: {tool_commit}")

    # Resolve config
    print("[INFO] Resolving config...")
    resolved_config = resolve_config(tool_info, args.tool, args.experiment)

    # Create snapshot directory
    snapshot_dir = Path(f"configs/{args.tool}/snapshots/{args.tag}")
    snapshot_dir.mkdir(parents=True, exist_ok=True)

    # Write snapshot file
    snapshot_file = snapshot_dir / f"{args.experiment}.yaml"
    timestamp = datetime.now().isoformat()

    header = f"""# SNAPSHOT: {args.tool}/{args.experiment}
# TAG: {args.tag}
# TOOL_COMMIT: {tool_commit}
# TIMESTAMP: {timestamp}
# DO NOT EDIT - regenerate with: python scripts/snapshot_experiment {args.tool} {args.experiment} --tag {args.tag}

"""

    snapshot_file.write_text(header + resolved_config)
    print(f"[INFO] Snapshot written: {snapshot_file}")

    # Optionally create git commit
    if args.commit:
        print("[INFO] Creating git commit...")

        # Stage snapshot
        subprocess.run(["git", "add", str(snapshot_dir)])

        # Stage tool submodule (pins current commit)
        subprocess.run(["git", "add", str(tool_path)])

        # Commit
        message = args.message or f"Snapshot: {args.tool}/{args.experiment} @ {args.tag}"
        result = subprocess.run(
            ["git", "commit", "-m", message],
            capture_output=True,
            text=True,
        )

        if result.returncode == 0:
            print(f"[INFO] Committed: {message}")

            # Create tag
            tag_name = f"snapshot/{args.tag}"
            subprocess.run(["git", "tag", tag_name])
            print(f"[INFO] Tagged: {tag_name}")
        else:
            if "nothing to commit" in result.stdout:
                print("[INFO] Nothing to commit (snapshot unchanged)")
            else:
                print(f"[WARNING] Commit failed: {result.stderr}")

    print("\n" + "=" * 60)
    print(f"[OK] Snapshot created: {args.tag}")
    print("=" * 60)
    print("\nTo reproduce:")
    print(f"  git checkout snapshot/{args.tag}")
    print("  git submodule update --init")
    print(f"  python scripts/run_experiment {args.tool} {args.experiment}")

    return 0


if __name__ == "__main__":
    sys.exit(main())
